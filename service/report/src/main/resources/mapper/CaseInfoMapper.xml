<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.fintecher.pangolin.report.mapper.CaseInfoMapper">
    <resultMap id="caseInfoBean" type="cn.fintecher.pangolin.report.entity.CaseInfo">
        <id column="id" property="id"/>
        <result column="batch_number" property="batchNumber"/>
        <result column="case_number" property="caseNumber"/>
        <result column="contract_amount" property="contractAmount"/>
        <result column="collection_type" property="collectionType"/>
        <result column="overdue_fine" property="overdueFine"/>
        <result column="overdue_delay_fine" property="overdueDelayFine"/>
        <result column="periods" property="periods"/>
        <result column="loan_date" property="loanDate"/>
        <result column="per_due_date" property="perDueDate"/>
        <result column="per_pay_amount" property="perPayAmount"/>
        <result column="overdue_days" property="overdueDays"/>
        <result column="overdue_periods" property="overduePeriods"/>
        <result column="lately_pay_amount" property="latelyPayAmount"/>
        <result column="overdue_amount" property="overdueAmount"/>
        <result column="overdue_capital" property="overdueCapital"/>
        <result column="overdue_interest" property="overdueInterest"/>
        <result column="has_pay_amount" property="hasPayAmount"/>
        <result column="has_pay_periods" property="hasPayPeriods"/>
        <result column="leave_date" property="leaveDate"/>
        <result column="lately_pay_date" property="latelyPayDate"/>
        <result column="assist_flag" property="assistFlag"/>
        <result column="assist_status" property="assistStatus"/>
        <result column="has_leave_days" property="hasLeaveDays"/>
        <result column="assist_way" property="assistWay"/>
        <result column="hold_days" property="holdDays"/>
        <result column="operator_time" property="operatorTime"/>
        <result column="left_days" property="leftDays"/>
        <result column="leave_case_flag" property="leaveCaseFlag"/>
        <result column="promise_amt" property="promiseAmt"/>
        <result column="promise_time" property="promiseTime"/>
        <result column="case_follow_in_time" property="caseFollowInTime"/>
        <result column="pay_status" property="payStatus"/>
        <result column="collection_status" property="collectionStatus"/>
        <result column="overdue_manage_fee" property="overdueManageFee"/>
        <result column="derate_amt" property="derateAmt"/>
        <result column="real_pay_amount" property="realPayAmount"/>
        <result column="early_real_settle_amt" property="earlyRealSettleAmt"/>
        <result column="early_derate_amt" property="earlyDerateAmt"/>
        <result column="early_settle_amt" property="earlySettleAmt"/>
        <result column="other_amt" property="otherAmt"/>
        <result column="left_capital" property="leftCapital"/>
        <result column="left_interest" property="leftInterest"/>
        <result column="followup_back" property="followupBack"/>
        <association property="personalInfo" column="personal_id" select="selectPersonal">
        </association>
        <association property="product" column="product_id" select = "selectProduct">
        </association>

        <association property="principalId" column="principal_id" select = "selectPrincipal">
        </association>
        <association property="area" column="area_id" select = "selectArea">
        </association>
    </resultMap>

    <resultMap id="personalMap" type="cn.fintecher.pangolin.entity.Personal">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="sex" property="sex"/>
        <result column="mobile_no" property="mobileNo"/>
        <result column="mobile_status" property="mobileStatus"/>
        <result column="id_card" property="idCard"/>
        <result column="local_home_address" property="localHomeAddress"/>
        <result column="longitude" property="longitude"/>
        <result column="latitude" property="latitude"/>
        <collection property="personalJobs" column="id"
                    ofType="cn.fintecher.pangolin.entity.PersonalJob" select="selectJob">
        </collection>
    </resultMap>

    <resultMap id = "personalJobMap" type="cn.fintecher.pangolin.entity.PersonalJob">
        <id column="id" property="id"/>
        <result column="company_name" property="companyName"/>
        <result column="department" property="department"/>
        <result column="phone" property="phone"/>
        <result column="rank" property="rank"/>
    </resultMap>

    <resultMap id="productMap" type="cn.fintecher.pangolin.entity.Product">
        <id column="id" property="id"/>
        <result column="prodcut_name" property="prodcutName"/>
    </resultMap>

    <resultMap id="principalMap" type="cn.fintecher.pangolin.entity.Principal">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
    </resultMap>

    <resultMap id="areaMap" type="cn.fintecher.pangolin.entity.AreaCode">
        <id column="id" property="id"/>
        <result column="area_name" property="areaName"/>
    </resultMap>

    <select id="selectJob" parameterType="String" resultMap="personalJobMap">
        select * from personal_job where personal_id = #{id}
    </select>

    <select id="selectProduct" parameterType="String" resultMap="productMap">
        select id,prodcut_name from product where id = #{product_id}
    </select>

    <select id="selectPrincipal" parameterType="String" resultMap="principalMap">
        select id,name from principal where id = #{principal_id}
    </select>

    <select id="selectArea" parameterType="String" resultMap="areaMap">
        select id,area_name from area_code where id = #{area_id}
    </select>

    <select id="queryWaitCollectCase" parameterType="cn.fintecher.pangolin.report.model.CaseInfoParams"
            resultMap="caseInfoBean">
        select b.id,b.batch_number,b.case_number,b.contract_amount,b.overdue_fine,b.collection_type,b.overdue_amount,b.left_capital,b.left_interest,b.overdue_capital,
        b.overdue_interest,b.has_pay_amount,b.assist_flag,b.assist_status,b.assist_way,b.hold_days,b.left_days,b.leave_case_flag,b.overdue_delay_fine,b.periods,
        b.has_leave_days,b.case_follow_in_time,b.pay_status,b.collection_status,b.overdue_manage_fee,b.derate_amt,b.real_pay_amount,b.per_pay_amount,b.per_due_date,
        b.early_settle_amt,b.early_real_settle_amt,b.early_derate_amt,b.other_amt,b.followup_back,b.product_id,b.overdue_periods,b.overdue_days,
        b.has_pay_periods,b.lately_pay_date,b.lately_pay_amount,b.leave_date,b.operator_time,b.promise_amt,b.promise_time,b.area_id,b.loan_date,b.early_derate_amt,
        b.principal_id,b.personal_id,b.early_real_settle_amt from
        (
        select a.*
        from case_info a ,department b,personal p
        where a.depart_id=b.id
        and b.code like CONCAT(#{deptCode}, '%')
        and a.company_code = #{companyCode}
        and a.collection_type=16
        and a.collection_status = 20
        and a.case_type in(173,181)
        and a.personal_id = p.id
        <if test="name != null">
            and p.name like CONCAT('%',#{name}, '%')
        </if>
        <if test="address != null">
            and p.local_home_address like CONCAT('%', #{address}, '%')
        </if>
        UNION ALL
        select b.*
        from case_assist a ,case_info b,department c,personal p
        where a.case_id=b.id
        and a.depart_id=c.id
        and c.code like CONCAT(#{deptCode}, '%')
        and a.company_code = #{companyCode}
        and a.assist_status = 118
        and b.personal_id = p.id
        <if test="name != null">
            and p.name like CONCAT('%',#{name}, '%')
        </if>
        <if test="address != null">
            and p.local_home_address like CONCAT('%', #{address}, '%')
        </if>
        ) as b
    </select>

    <select id="queryWaitOwnCollectCase" parameterType="cn.fintecher.pangolin.report.model.CaseInfoParams"
            resultMap="caseInfoBean">
        select b.id,b.batch_number,b.case_number,b.contract_amount,b.overdue_fine,b.collection_type,b.overdue_amount,b.left_capital,b.left_interest,b.overdue_capital,
        b.overdue_interest,b.has_pay_amount,b.assist_flag,b.assist_status,b.assist_way,b.hold_days,b.left_days,b.leave_case_flag,b.overdue_delay_fine,b.periods,
        b.has_leave_days,b.case_follow_in_time,b.pay_status,b.collection_status,b.overdue_manage_fee,b.derate_amt,b.real_pay_amount,b.per_pay_amount,b.per_due_date,
        b.early_settle_amt,b.early_real_settle_amt,b.early_derate_amt,b.other_amt,b.followup_back,b.product_id,b.overdue_periods,b.overdue_days,
        b.has_pay_periods,b.lately_pay_date,b.lately_pay_amount,b.leave_date,b.operator_time,b.promise_amt,b.promise_time,b.area_id,b.loan_date,b.early_derate_amt,
        b.principal_id,b.personal_id,b.early_real_settle_amt from
        (
        SELECT
        a.*
        FROM
        case_info AS a, personal AS p
        WHERE
        a.company_code = #{companyCode}
        and	a.collection_status = 20
        and a.current_collector = #{collector}
        and a.case_type in(173,181)
        and a.personal_id = p.id
        <if test="name != null">
            and p.name like CONCAT('%',#{name}, '%')
        </if>
        <if test="address != null">
            and p.local_home_address like CONCAT('%', #{address}, '%')
        </if>
        UNION ALL
        SELECT
        b.*
        from case_info as b, case_assist as a,personal as p
        WHERE
        a.company_code = #{companyCode}
        and a.assist_collector= #{collector}
        and a.assist_status = 118
        and a.case_id = b.id
        and b.personal_id = p.id
        <if test="name != null">
            and p.name like CONCAT('%',#{name}, '%')
        </if>
        <if test="address != null">
            and p.local_home_address like CONCAT('%', #{address}, '%')
        </if>
        ) as b
        ORDER BY b.operator_time desc
    </select>

    <select id="selectPersonal" parameterType="String" resultMap="personalMap">
    select p.id,p.name,p.sex,p.mobile_no,p.mobile_status,p.id_card,p.local_home_address,p.longitude,p.latitude
    from personal p where p.id = #{personal_id}
  </select>

    <update id="updateLngLat"  parameterType="cn.fintecher.pangolin.entity.Personal">
      update personal
      set longitude = #{longitude},latitude = #{latitude}
      where id = #{id}
  </update>

    <select id = "queryCollectingCase" parameterType="cn.fintecher.pangolin.report.model.CollectingCaseParams" resultType="cn.fintecher.pangolin.report.model.CollectingCaseInfo">
        select a.batch_number as batchNumber,a.name,a.caseFollowInTime,a.delegationDate,a.closeDate,a.leftDays,a.caseNum,a.caseAmt,a.endCaseAmt,ifnull(b.endCaseNum,0) as endCaseNum,truncate(ifnull(( b.endCaseNum/caseNum),0),4) as numRate,truncate((endCaseAmt/caseAmt),4) as amtRate
        from
        (
            select aa.batch_number,aa.caseFollowInTime,aa.delegationDate,aa.closeDate,aa.leftDays,aa.caseNum,aa.caseAmt,aa.endCaseAmt,ab.name
            from
				(
				    select batch_number,principal_id,MIN(case_follow_in_time) as caseFollowInTime ,MIN(delegation_date) as delegationDate,Max(close_date) as closeDate,Min(left_days) as leftDays,count(*) as caseNum,sum(overdue_amount) as caseAmt,sum(real_pay_amount+early_real_settle_amt) as endCaseAmt
                    from case_info cc
                    left join department on cc.depart_id = department.id
                    where 1 = 1
                    and department.code like CONCAT(#{deptCode}, '%')
                    and (collection_status in (20,21,22,23,171,172) or (collection_status =25 and depart_id is not null))
                    and case_pool_type = 225
                    and recover_remark = 0
                    <if test = "batchNumber != null">
                        and batch_number = #{batchNumber}
                    </if>
                    <if test = "delegationDate != null">
                        and delegation_date &gt; #{delegationDate}
                    </if>
                    <if test = "closeDate != null">
                        and close_date &lt; #{closeDate}
                    </if>
                    <if test = "companyCode != null">
                        and cc.company_code = #{companyCode}
                    </if>
				    GROUP BY batch_number,principal_id
				)as aa
				inner join
				(
				    select id,name from principal
                    where 1 = 1
                    <if test = "principalId != null">
                        and name = #{principalId}
                    </if>
				) as ab
                on aa.principal_id = ab.id
        )
		as a
        left join
            (
	            select batch_number,count(id) as endCaseNum
	            from case_info
	            where collection_status = 171
                and case_pool_type = 225
	            GROUP BY batch_number
            ) as b
            on a.batch_number = b.batch_number
    </select>
</mapper>