<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.fintecher.pangolin.report.mapper.QueryOutsourcePoolMapper">

    <resultMap id="queryOutsourcePool" type="cn.fintecher.pangolin.report.model.QueryOutsourcePool">
        <result column="outs_name" property="outsName"/>
        <result column="come_outsource_time" property="comeOutsourceTime"/>
        <result column="out_batch" property="batchNumber"/>
        <result column="out_time" property="outTime"/>
        <result column="over_outsource_time" property="overOutsourceTime"/>
        <result column="left_days" property="leftDay"/>
        <result column="total_outsource_count" property="outcaseTotalCount"/>
        <result column="total_outsource_amt" property="outcaseTotalAmt"/>
        <result column="end_outsource_count" property="outcaseClosedCount"/>
        <result column="outsource_count_rate" property="outcaseCountRate"/>
        <result column="end_outsource_amt" property="outcaseClosedAmt"/>
        <result column="outsource_amt_rate" property="outcaseAmtRate"/>
        <result column="company_code" property="companyCode"/>
        <result column="outs_code" property="outsCode"/>
        <result column="current_outsource_count" property="currentOutsourceCount"/>
        <result column="current_outsource_amt" property="currentOutsourceAmt"/>
    </resultMap>

    <!-- 委外催收中按批次号查询 -->
    <select id="getAllOutSourcePoolByBatchNumber" parameterType="cn.fintecher.pangolin.report.model.QueryOutsourcePoolParams"
            resultMap="queryOutsourcePool">
        SELECT bb.outs_name,bb.come_outsource_time,bb.out_batch,DATE_FORMAT(bb.out_time,'%Y-%m-%d') as out_time,bb.over_outsource_time,bb.left_days,bb.total_outsource_count,bb.total_outsource_amt,IFNULL(cc.end_outsource_count,0) as end_outsource_count,IFNULL((cc.end_outsource_count/bb.total_outsource_count),0.00) as outsource_count_rate, IFNULL(cc.end_outsource_amt,0.00) as end_outsource_amt ,IFNULL((cc.end_outsource_amt/bb.total_outsource_amt), 0.00) as outsource_amt_rate, bb.company_code, bb.outs_code,(total_outsource_count - IFNULL(end_outsource_count,0)) as current_outsource_count, (total_outsource_amt - IFNULL(end_outsource_amt,0.00)) as current_outsource_amt
        FROM (SELECT aa.outs_code, aa.outs_name,MIN(aa.come_outsource_time) as come_outsource_time, aa.out_batch, MIN(aa.out_time) as out_time,Max(aa.over_outsource_time) as over_outsource_time, Max(aa.left_days) as left_days, sum(aa.contract_amt) as total_outsource_amt, count(*) as total_outsource_count,aa.company_code, aa.recover_remark
        FROM (SELECT d.case_pool_type,d.recover_remark,c.outs_name,a.out_time as come_outsource_time,a.out_batch,a.out_time,a.over_outsource_time,TIMESTAMPDIFF(DAY,curdate(),over_outsource_time) as left_days,a.contract_amt,a.out_status, a.company_code, c.outs_code
        FROM outsource  c
        INNER JOIN outsource_pool a on c.id=a.out_id
        LEFT JOIN case_info d on a.case_id=d.id) as aa where aa.recover_remark = 0 and aa.case_pool_type=226 GROUP BY aa.out_batch, aa.outs_name,aa.company_code,aa.outs_code) as bb
        LEFT JOIN (SELECT dd.out_batch,dd.outs_name, IFNULL(ff.end_outsource_count,0) as end_outsource_count , (dd.out_total_back_amt+IFNULL(ff.end_total_outsource_amt,0.00)) as end_outsource_amt, dd.company_code
        from (SELECT f.out_batch,e.outs_name,sum(f.out_back_amt) as out_total_back_amt, f.company_code, g.case_pool_type
        FROM outsource e
        INNER JOIN outsource_pool f on e.id=f.out_id
        LEFT JOIN case_info g on g.id = f.case_id
        where g.case_pool_type=226 GROUP BY f.out_batch,e.outs_name, f.company_code,g.case_pool_type) as dd
        LEFT JOIN (SELECT g.case_pool_type,a.out_batch,c.outs_name,count(*) as end_outsource_count,sum(case when a.out_back_amt=0.0000 then a.contract_amt ELSE 0.0000 end) as end_total_outsource_amt, a.company_code, a.out_back_amt
        FROM outsource c
        INNER JOIN outsource_pool a on c.id=a.out_id
        LEFT JOIN case_info g on g.id = a.case_id
        WHERE a.out_status=170 and g.case_pool_type=226 GROUP BY a.out_batch,c.outs_name, a.company_code, a.out_back_amt,g.case_pool_type) as ff on ff.out_batch=dd.out_batch and ff.outs_name=dd.outs_name and ff.company_code=dd.company_code) as cc on bb.out_batch=cc.out_batch and bb.outs_name=cc.outs_name and cc.company_code=bb.company_code
        <if test="companyCode != null and companyCode != ''">
            AND bb.company_code = #{companyCode}
        </if>
        <if test="batchNumber != null and batchNumber != ''">
            AND bb.out_batch = #{batchNumber}
        </if>
        <if test="outsName != null and outsName != ''">
            AND bb.outs_name = #{outsName}
        </if>
        <if test="outTimeStart != null and outTimeStart != ''">
            AND <![CDATA[DATE_FORMAT(out_time,'%Y-%m-%d') >= DATE_FORMAT(#{outTimeStart},'%Y-%m-%d')]]>
        </if>
        <if test="outTimeEnd != null and outTimeEnd !=''">
            AND <![CDATA[DATE_FORMAT(out_time,'%Y-%m-%d') <= DATE_FORMAT(#{outTimeEnd},'%Y-%m-%d')]]>
        </if>
        <if test="overOutsourceTimeStart != null and overOutsourceTimeStart != ''">
            AND <![CDATA[DATE_FORMAT(over_outsource_time,'%Y-%m-%d') >= DATE_FORMAT(#{overOutsourceTimeStart},'%Y-%m-%d')]]>
        </if>
        <if test="overOutsourceTimeEnd != null and overOutsourceTimeEnd != ''">
            AND <![CDATA[DATE_FORMAT(over_outsource_time,'%Y-%m-%d') <= DATE_FORMAT(#{overOutsourceTimeEnd},'%Y-%m-%d')]]>
        </if>
        ORDER BY out_batch desc
    </select>

    <!-- 委外催收中按委外方查询 -->
    <select id="getAllOutSourceByOutsName" parameterType="cn.fintecher.pangolin.report.model.QueryOutsourcePoolParams"
            resultMap="queryOutsourcePool">
        SELECT bb.outs_name,bb.total_outsource_count,bb.total_outsource_amt,IFNULL(cc.end_outsource_count,0) as end_outsource_count,IFNULL((cc.end_outsource_count/bb.total_outsource_count),0.00) as outsource_count_rate, IFNULL(cc.end_outsource_amt,0.00) as end_outsource_amt ,IFNULL((cc.end_outsource_amt/bb.total_outsource_amt), 0.00) as outsource_amt_rate, bb.company_code, bb.outs_code,(total_outsource_count - IFNULL(end_outsource_count,0)) as current_outsource_count, (total_outsource_amt - IFNULL(end_outsource_amt,0.00)) as current_outsource_amt
        FROM (SELECT aa.outs_code, aa.outs_name, sum(aa.contract_amt) as total_outsource_amt, count(*) as total_outsource_count,aa.company_code, aa.recover_remark, aa.case_pool_type
        FROM (SELECT d.case_pool_type,d.recover_remark,c.outs_name,a.contract_amt,a.out_status, a.company_code, c.outs_code
        FROM outsource  c
        INNER JOIN outsource_pool a on c.id=a.out_id
        LEFT JOIN case_info d on a.case_id=d.id) as aa where aa.recover_remark = 0 and aa.case_pool_type=226 GROUP BY aa.outs_name,aa.company_code,aa.outs_code) as bb
        LEFT JOIN (SELECT dd.outs_name, IFNULL(ff.end_outsource_count,0) as end_outsource_count, (dd.out_back_amt+IFNULL(ff.end_outsource_amt,0.00)) as end_outsource_amt, dd.company_code
        from (SELECT e.outs_name,sum(f.out_back_amt) as out_back_amt, f.company_code,g.case_pool_type
        FROM outsource e
        INNER JOIN outsource_pool f on e.id=f.out_id
        LEFT JOIN case_info g on g.id = f.case_id
        WHERE g.case_pool_type=226 GROUP BY e.outs_name, f.company_code,g.case_pool_type) as dd
        LEFT JOIN (SELECT c.outs_name, count(*) as end_outsource_count,sum( case when a.out_back_amt=0.0000 then a.contract_amt else 0.0000 END) as end_outsource_amt, a.company_code,g.case_pool_type
        FROM outsource c
        INNER JOIN outsource_pool a on c.id=a.out_id
        LEFT JOIN case_info g on g.id = a.case_id
        WHERE a.out_status=170 and g.case_pool_type=226 GROUP BY c.outs_name, a.company_code) as ff on ff.outs_name=dd.outs_name and ff.company_code=dd.company_code) as cc on bb.outs_name=cc.outs_name and cc.company_code=bb.company_code
        <if test="companyCode != null and companyCode != ''">
            AND bb.company_code = #{companyCode}
        </if>
        <if test="outsName != null and outsName != ''">
            AND bb.outs_name = #{outsName}
        </if>
        ORDER BY outs_name desc
    </select>


</mapper>